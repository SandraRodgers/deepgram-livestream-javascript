<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Audio Stream From URL Demo</title>
  </head>
  <body>
    <p id="captions"></p>

    <script>
      let stream;

      //open connection to Deepgram
      const socket = new WebSocket("wss://api.deepgram.com/v1/listen", [
        "token",
        "API_TOKEN",
      ]);

      socket.onopen = () => {
        const url =
          "http://stream.live.vc.bbcmedia.co.uk/bbc_radio_fourlw_online_nonuk";
        fetch(url)
          .then((response) => response.body)
          .then((body) => {
            // use method to parse audio data
            readAllChunks(body);
          });
      };

      async function readAllChunks(readableStream) {
        const reader = readableStream.getReader();
        const chunks = [];
        let done, value;
        while (!done) {
          ({ value, done } = await reader.read());
          socket.send(value);
          if (done) {
            console.log(chunks);
            return chunks;
          }
          chunks.push(value);
        }
      }

      // Put the transcript onto the screen in the #captions element
      socket.onmessage = (message) => {
        console.log("hey");
        const received = JSON.parse(message.data);
        const transcript = received.channel.alternatives[0].transcript;
        if (transcript && received.is_final) {
          document.querySelector("#captions").textContent += transcript + " ";
        }
      };

      socket.onclose = () => {
        console.log({ event: "onclose" });
      };

      socket.onerror = (error) => {
        console.log({ event: "onerror", error });
      };
    </script>
  </body>
</html>
